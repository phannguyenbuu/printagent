<script>
function clamp(v, min, max) {
  return Math.max(min, Math.min(max, v));
}

function avg(values) {
  if (!values.length) return 0;
  return Math.round(values.reduce((a, b) => a + b, 0) / values.length);
}

function makePath(values, width, height, pad) {
  if (!values.length) return "";
  const min = Math.min(...values);
  const max = Math.max(...values);
  const spread = Math.max(max - min, 1);
  return values
    .map((value, idx) => {
      const x = pad + (idx * (width - pad * 2)) / Math.max(values.length - 1, 1);
      const normalized = (value - min) / spread;
      const y = height - pad - normalized * (height - pad * 2);
      return `${idx === 0 ? "M" : "L"} ${x.toFixed(2)} ${y.toFixed(2)}`;
    })
    .join(" ");
}

function jsonString(value) {
  return JSON.stringify(value, null, 2);
}

function formatCounterResult(payload) {
  const data = payload || {};
  const counter = data.counter_data || {};
  const status = data.status_data || {};
  const lines = [];
  lines.push("COUNTER DATA");
  lines.push(`printer_name: ${data.printer_name || "-"}`);
  lines.push(`ip: ${data.ip || "-"}`);
  lines.push(`timestamp: ${data.timestamp || "-"}`);
  lines.push("");
  lines.push("counter_data:");
  const orderedKeys = [
    "total",
    "copier_bw",
    "printer_bw",
    "fax_bw",
    "send_tx_total_bw",
    "send_tx_total_color",
    "fax_transmission_total",
    "scanner_send_bw",
    "scanner_send_color",
    "coverage_copier_bw",
    "coverage_printer_bw",
    "coverage_fax_bw",
    "a3_dlt",
    "duplex",
  ];
  orderedKeys.forEach((key) => {
    lines.push(`  - ${key}: ${counter[key] || "0"}`);
  });
  lines.push("");
  lines.push("status_data:");
  const statusKeys = Object.keys(status).sort();
  if (!statusKeys.length) {
    lines.push("  - (empty)");
  } else {
    statusKeys.forEach((key) => {
      lines.push(`  - ${key}: ${status[key]}`);
    });
  }
  return lines.join("\n");
}

function buildCounterHtmlPreview(payload) {
  const data = payload || {};
  const rawHtml = String(data.html || "");
  if (!rawHtml) return "";
  const ip = String(data.ip || "").trim();
  const baseTag = ip ? `<base href="http://${ip}/">` : "";
  let prepared = rawHtml.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, "");
  if (baseTag) {
    if (/<head[^>]*>/i.test(prepared)) {
      prepared = prepared.replace(/<head([^>]*)>/i, `<head$1>${baseTag}`);
    } else {
      prepared = `${baseTag}${prepared}`;
    }
  }
  return prepared;
}

function setResultModalView(mode) {
  const summaryBtn = document.getElementById("result-modal-view-summary");
  const htmlBtn = document.getElementById("result-modal-view-html");
  const modalBody = document.getElementById("result-modal-body");
  const htmlFrame = document.getElementById("result-modal-html");
  if (!summaryBtn || !htmlBtn || !modalBody || !htmlFrame) return;
  const htmlEnabled = htmlBtn.dataset.enabled === "1";
  const target = mode === "html" && htmlEnabled ? "html" : "summary";
  summaryBtn.classList.toggle("active", target === "summary");
  htmlBtn.classList.toggle("active", target === "html");
  modalBody.hidden = target !== "summary";
  htmlFrame.hidden = target !== "html";
}

async function jsonFetch(url, options = {}) {
  const res = await fetch(url, options);
  let body = {};
  try {
    body = await res.json();
  } catch (_e) {
    body = {};
  }
  if (!res.ok) {
    const message = body.error || body.message || `HTTP ${res.status}`;
    throw new Error(message);
  }
  return body;
}

function renderTrendChart(el, labels, seriesA, seriesB, seriesC) {
  if (!el) return;
  const width = 900;
  const height = 320;
  const pad = 30;
  const grid = [];
  for (let i = 0; i < 5; i++) {
    const y = pad + ((height - pad * 2) / 4) * i;
    grid.push(`<line x1="${pad}" y1="${y}" x2="${width - pad}" y2="${y}" stroke="#e6edf7" stroke-width="1" />`);
  }
  const labelNodes = labels
    .map((label, idx) => {
      const x = pad + (idx * (width - pad * 2)) / Math.max(labels.length - 1, 1);
      return `<text x="${x}" y="${height - 8}" font-size="11" fill="#728197" text-anchor="middle">${label}</text>`;
    })
    .join("");

  el.innerHTML = `
    ${grid.join("")}
    <path d="${makePath(seriesA, width, height, pad)}" fill="none" stroke="#2e78ff" stroke-width="4" stroke-linecap="round" />
    <path d="${makePath(seriesB, width, height, pad)}" fill="none" stroke="#ff7a1a" stroke-width="4" stroke-linecap="round" />
    <path d="${makePath(seriesC, width, height, pad)}" fill="none" stroke="#10b8b8" stroke-width="4" stroke-linecap="round" />
    ${labelNodes}
  `;
}

function renderBars(el, labels, a, b, c) {
  if (!el) return;
  const maxVal = Math.max(...a, ...b, ...c, 1);
  el.innerHTML = labels
    .map((label, i) => {
      const ha = clamp((a[i] / maxVal) * 100, 4, 100);
      const hb = clamp((b[i] / maxVal) * 100, 4, 100);
      const hc = clamp((c[i] / maxVal) * 100, 4, 100);
      return `
      <div class="bar-col">
        <div class="bar-stack">
          <div class="bar a" style="height:${ha}%"></div>
          <div class="bar b" style="height:${hb}%"></div>
          <div class="bar c" style="height:${hc}%"></div>
        </div>
        <div class="bar-label">${label}</div>
      </div>`;
    })
    .join("");
}

async function loadOverview() {
  const data = await jsonFetch("/api/overview");
  const stats = data.stats || {};
  const trend = data.trend || {};
  const alerts = data.alerts || [];

  const byId = (id) => document.getElementById(id);
  if (byId("stat-total")) byId("stat-total").textContent = stats.total_devices ?? "--";
  if (byId("stat-ricoh")) byId("stat-ricoh").textContent = stats.ricoh_devices ?? "--";
  if (byId("stat-active")) byId("stat-active").textContent = stats.active_devices ?? "--";
  if (byId("stat-offline")) byId("stat-offline").textContent = stats.offline_devices ?? "--";
  const copierTotal = byId("stat-copier-total");
  const printTotal = byId("stat-print-total");
  const scanTotal = byId("stat-scan-total");
  if (copierTotal) copierTotal.textContent = stats.copier_pages_total ?? "--";
  if (printTotal) printTotal.textContent = stats.print_pages_total ?? "--";
  if (scanTotal) scanTotal.textContent = stats.scan_pages_total ?? "--";

  renderBars(
    byId("bar-chart"),
    trend.labels || [],
    trend.copier_pages || [],
    trend.print_pages || [],
    trend.scan_pages || []
  );

  renderTrendChart(
    byId("trend-chart"),
    trend.labels || [],
    trend.copier_pages || [],
    trend.print_pages || [],
    trend.scan_pages || []
  );

  renderTrendChart(
    byId("analytics-chart"),
    trend.labels || [],
    trend.copier_pages || [],
    trend.print_pages || [],
    trend.scan_pages || []
  );

  if (byId("avg-copier")) byId("avg-copier").textContent = avg(trend.copier_pages || []);
  if (byId("avg-print")) byId("avg-print").textContent = avg(trend.print_pages || []);
  if (byId("avg-scan")) byId("avg-scan").textContent = avg(trend.scan_pages || []);

  const alertsEl = byId("alerts");
  if (alertsEl) {
    alertsEl.innerHTML = alerts
      .map(
        (item) => `
      <div class="alert-item">
        <div>${item.title}</div>
        <div class="count">${item.count}</div>
      </div>`
      )
      .join("");
  }
}

async function runAction(ip, action, options = {}) {
  const silent = Boolean(options.silent);
  const out = document.getElementById("collect-output");
  if (out) out.textContent = `Running ${action} on ${ip}...`;
  const simplifyError = (raw) => {
    const msg = String(raw || "");
    const lowered = msg.toLowerCase();
    if (
      lowered.includes("connecttimeout") ||
      lowered.includes("timed out") ||
      lowered.includes("max retries exceeded")
    ) {
      return `Device ${ip || ""} is unreachable (connection timeout).`;
    }
    if (lowered.includes("connection refused")) {
      return `Device ${ip || ""} refused the connection.`;
    }
    if (lowered.includes("name or service not known") || lowered.includes("nodename nor servname")) {
      return `Cannot resolve device address: ${ip || "unknown host"}.`;
    }
    return `Action "${action}" failed for ${ip || "selected device"}.`;
  };

  try {
    const data = await jsonFetch("/api/devices/action", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ ip, action }),
    });
    if (data.ok) {
      if (out) out.textContent = jsonString(data);
      if (!out && !silent) {
        let msg = data.message || `${action} succeeded`;
        if (action === "counter") {
          const c = data?.payload?.counter_data || {};
          msg = `Counter ${ip}: total=${c.total || "-"}, copier_bw=${c.copier_bw || "-"}, printer_bw=${c.printer_bw || "-"}, scanner_bw=${c.scanner_send_bw || "-"}`;
        } else if (action === "status") {
          const s = data?.payload?.status_data || {};
          msg = `Status ${ip}: system=${s.system_status || "-"}, printer=${s.printer_status || s.printer_alerts || "-"}`;
        }
        alert(msg);
      }
      return data;
    }
    const friendly = simplifyError(data.error || "Unknown error");
    if (out) out.textContent = friendly;
    if (!out && !silent) alert(friendly);
    return { ...data, ok: false, error: friendly };
  } catch (err) {
    const friendly = simplifyError(err?.message || err);
    if (out) out.textContent = friendly;
    if (!out && !silent) alert(friendly);
    return { ok: false, error: friendly };
  }
}

function showResultModal(title, payload) {
  const modal = document.getElementById("result-modal");
  const modalTitle = document.getElementById("result-modal-title");
  const modalLoading = document.getElementById("result-modal-loading");
  const modalTools = document.getElementById("result-modal-tools");
  const summaryBtn = document.getElementById("result-modal-view-summary");
  const htmlBtn = document.getElementById("result-modal-view-html");
  const modalBody = document.getElementById("result-modal-body");
  const htmlFrame = document.getElementById("result-modal-html");
  if (!modal || !modalTitle || !modalBody || !modalLoading || !modalTools || !summaryBtn || !htmlBtn || !htmlFrame) return;
  modalTitle.textContent = title;
  modalLoading.hidden = true;
  const htmlPreview = buildCounterHtmlPreview(payload);
  const htmlReady = Boolean(htmlPreview);
  if (payload && typeof payload === "object" && ("counter_data" in payload || "status_data" in payload)) {
    modalBody.textContent = formatCounterResult(payload);
    htmlBtn.dataset.enabled = htmlReady ? "1" : "0";
    htmlBtn.disabled = !htmlReady;
    htmlFrame.srcdoc = htmlPreview || "<html><body><p>No HTML payload.</p></body></html>";
    modalTools.hidden = false;
    setResultModalView("summary");
  } else {
    modalBody.textContent = jsonString(payload || {});
    htmlBtn.dataset.enabled = "0";
    htmlBtn.disabled = true;
    htmlFrame.srcdoc = "";
    modalTools.hidden = true;
    setResultModalView("summary");
  }
  modal.hidden = false;
}

function showResultModalLoading(title, loadingText) {
  const modal = document.getElementById("result-modal");
  const modalTitle = document.getElementById("result-modal-title");
  const modalLoading = document.getElementById("result-modal-loading");
  const modalLoadingText = document.getElementById("result-modal-loading-text");
  const modalTools = document.getElementById("result-modal-tools");
  const htmlBtn = document.getElementById("result-modal-view-html");
  const modalBody = document.getElementById("result-modal-body");
  const htmlFrame = document.getElementById("result-modal-html");
  if (!modal || !modalTitle || !modalBody || !modalLoading || !modalLoadingText || !modalTools || !htmlBtn || !htmlFrame) return;
  modalTitle.textContent = title;
  modalLoadingText.textContent = loadingText || "Loading...";
  modalBody.textContent = "";
  htmlFrame.srcdoc = "";
  htmlBtn.dataset.enabled = "0";
  htmlBtn.disabled = true;
  modalTools.hidden = true;
  modalBody.hidden = true;
  htmlFrame.hidden = true;
  modalLoading.hidden = false;
  modal.hidden = false;
}

function showResultModalError(title, message) {
  const modal = document.getElementById("result-modal");
  if (!modal) return;
  showResultModal(title, { ok: false, error: String(message || "Unknown error") });
}

function bindResultModal() {
  const modal = document.getElementById("result-modal");
  const closeBtn = document.getElementById("result-modal-close");
  const summaryBtn = document.getElementById("result-modal-view-summary");
  const htmlBtn = document.getElementById("result-modal-view-html");
  if (!modal || !closeBtn || !summaryBtn || !htmlBtn || closeBtn.dataset.bound) return;
  const close = () => {
    modal.hidden = true;
  };
  closeBtn.dataset.bound = "1";
  closeBtn.addEventListener("click", close);
  summaryBtn.addEventListener("click", () => setResultModalView("summary"));
  htmlBtn.addEventListener("click", () => setResultModalView("html"));
  modal.addEventListener("click", (event) => {
    if (event.target === modal) close();
  });
}

function setRowEnabled(row, enabled) {
  if (!row) return;
  row.classList.toggle("device-row-disabled", !enabled);
  row.querySelectorAll("button, input, select, textarea").forEach((el) => {
    if (el.dataset.rowChecker === "enable") return;
    el.disabled = !enabled;
  });
}

function getDeviceFilterMode() {
  const validOnlyInput = document.getElementById("valid-printer-only");
  return validOnlyInput?.checked ? "valid_only" : "all";
}

function isValidPrinterName(name) {
  const blockedPrefixes = ["microsoft", "microsft", "ruskdesk", "rustdesk", "anydesk", "fax", "foxit"];
  const lowered = String(name || "").trim().toLowerCase();
  if (!lowered) return true;
  return !blockedPrefixes.some((prefix) => lowered.startsWith(prefix));
}

function applyValidPrinterFilter() {
  const body = document.getElementById("device-table-body");
  if (!body) return;
  const validOnly = getDeviceFilterMode() === "valid_only";
  body.querySelectorAll("tr[data-printer-name]").forEach((row) => {
    const name = row.dataset.printerName || "";
    row.style.display = validOnly && !isValidPrinterName(name) ? "none" : "";
  });
}

async function loadDevices(forceRefresh = false) {
  const body = document.getElementById("device-table-body");
  if (!body) return;
  body.innerHTML = `
    <tr>
      <td colspan="8">
        <div class="table-loading">
          <span class="spinner"></span>
          <span>Loading printers...</span>
        </div>
      </td>
    </tr>`;
  const url = forceRefresh ? "/api/devices?refresh=1" : "/api/devices";
  const data = await jsonFetch(url);
  const rawDevices = Array.isArray(data.devices) ? data.devices : [];
  const rankSource = (source) => {
    const s = String(source || "").toLowerCase();
    if (s === "api") return 3;
    if (s === "test") return 2;
    return 1;
  };
  const keyOf = (d) => {
    const ip = String(d?.ip || "").trim();
    if (ip) return `ip:${ip}`;
    const name = String(d?.name || "").trim().toLowerCase();
    const port = String(d?.port_name || "").trim().toLowerCase();
    return `name:${name}|port:${port}`;
  };
  const dedupMap = new Map();
  for (const row of rawDevices) {
    const key = keyOf(row);
    const prev = dedupMap.get(key);
    if (!prev) {
      dedupMap.set(key, row);
      continue;
    }
    if (rankSource(row?.source) > rankSource(prev?.source)) {
      dedupMap.set(key, row);
    }
  }
  const devices = Array.from(dedupMap.values());
  if (!devices.length) {
    body.innerHTML = `<tr><td colspan="8">No devices found.</td></tr>`;
    return;
  }
  body.innerHTML = devices
    .map((d) => {
      const hasIp = Boolean(d.ip);
      const isRicoh = String(d.type || "").toLowerCase() === "ricoh";
      const canQuery = hasIp && isRicoh;
      const isControllableSource = ["api", "test"].includes(String(d.source || "").toLowerCase());
      const canMachineControl = canQuery && isControllableSource;
      return `
      <tr data-printer-name="${String(d.name || "").replaceAll('"', "&quot;")}">
        <td>
          <label class="mini-switch">
            <input type="checkbox" data-row-checker="enable" data-machine-control="${canMachineControl ? "1" : "0"}" data-ip="${d.ip || ""}" checked />
            <span class="mini-slider"></span>
          </label>
        </td>
        <td>
          <button class="name-counter-trigger" data-counter-trigger="1" data-printer-name="${String(d.name || "").replaceAll('"', "&quot;")}" data-ip="${d.ip || ""}" ${canQuery ? "" : "disabled"}>${d.name}</button>
        </td>
        <td>${d.ip || "-"}</td>
        <td>${d.port_name || "-"}</td>
        <td>${d.connection_type || "-"}</td>
        <td>${d.type}</td>
        <td>${d.source || "-"}</td>
        <td>
          <label class="mini-switch">
            <input type="checkbox" data-row-checker="counter" data-ip="${d.ip || ""}" ${hasIp ? "" : "disabled"} />
            <span class="mini-slider"></span>
          </label>
        </td>
      </tr>`;
    })
    .join("");

  body.querySelectorAll("button[data-counter-trigger][data-ip]").forEach((btn) => {
    btn.addEventListener("click", async () => {
      const printerName = String(btn.dataset.printerName || btn.textContent || "Printer").trim();
      const baseTitle = `${printerName} (${btn.dataset.ip})`;
      showResultModalLoading(baseTitle, "Loading counter and status...");
      const [counterResult, statusResult] = await Promise.all([
        runAction(btn.dataset.ip, "counter", { silent: true }),
        runAction(btn.dataset.ip, "status", { silent: true }),
      ]);
      const modal = document.getElementById("result-modal");
      if (!modal || modal.hidden) return;
      if (!counterResult.ok && !statusResult.ok) {
        showResultModalError(
          baseTitle,
          counterResult.error || statusResult.error || "Request failed"
        );
        return;
      }
      const counterPayload = counterResult.payload || {};
      const statusPayload = statusResult.payload || {};
      const dataView = {
        printer_name: counterPayload.printer_name || statusPayload.printer_name || "Local Printer",
        ip: counterPayload.ip || statusPayload.ip || btn.dataset.ip || "",
        timestamp: counterPayload.timestamp || statusPayload.timestamp || "",
        counter_data: counterPayload.counter_data || {},
        status_data: statusPayload.status_data || {},
        html: counterPayload.html || "",
      };
      const timestamp = dataView.timestamp || "-";
      const finalTitle = `${baseTitle} [${timestamp}]`;
      showResultModal(finalTitle, dataView);
    });
  });

  const rowCheckerInputs = body.querySelectorAll("input[data-row-checker][data-ip]");
  const ipSet = new Set();
  rowCheckerInputs.forEach((inp) => {
    const ip = inp.dataset.ip || "";
    if (ip) ipSet.add(ip);
    if (inp.dataset.bound) return;
    inp.dataset.bound = "1";
    inp.addEventListener("change", async () => {
      const isChecked = inp.checked;
      const kind = inp.dataset.rowChecker;
      const row = inp.closest("tr");
      if (!ip) {
        if (kind === "enable") setRowEnabled(row, isChecked);
        return;
      }
      const canMachineControl = inp.dataset.machineControl === "1";
      if (kind === "enable" && !canMachineControl) {
        setRowEnabled(row, isChecked);
        return;
      }
      let action = "";
      if (kind === "enable") action = isChecked ? "enable_machine" : "lock_machine";
      if (kind === "counter") action = isChecked ? "log_counter_start" : "log_counter_stop";
      if (!action) return;
      const result = await runAction(ip, action);
      if (!result.ok) {
        inp.checked = !isChecked;
        return;
      }
      if (kind === "enable") {
        if (!isChecked) {
          const counterInp = row?.querySelector('input[data-row-checker="counter"]');
          if (counterInp) counterInp.checked = false;
        }
        setRowEnabled(row, isChecked);
      }
    });
  });

  body.querySelectorAll('input[data-row-checker="enable"]').forEach((enableInput) => {
    setRowEnabled(enableInput.closest("tr"), !enableInput.disabled && enableInput.checked);
  });

  for (const ip of ipSet) {
    try {
      const st = await runAction(ip, "job_status", { silent: true });
      const counterOn = Boolean(st.counter_running);
      const e = body.querySelector(`input[data-row-checker="enable"][data-ip="${ip}"]`);
      const c = body.querySelector(`input[data-row-checker="counter"][data-ip="${ip}"]`);
      if (e) {
        e.checked = true;
        setRowEnabled(e.closest("tr"), true);
      }
      if (c) c.checked = counterOn;
    } catch (_e) {}
  }

  applyValidPrinterFilter();
}

async function initDevicesPage() {
  bindResultModal();
  const validOnlyInput = document.getElementById("valid-printer-only");
  if (validOnlyInput && !validOnlyInput.dataset.bound) {
    validOnlyInput.dataset.bound = "1";
    try {
      const cfg = await jsonFetch("/api/dashboard/config");
      const mode = String(cfg?.device_filters?.filter_mode || "all");
      validOnlyInput.checked = mode === "valid_only";
    } catch (_e) {
      validOnlyInput.checked = false;
    }
    validOnlyInput.addEventListener("change", () => {
      applyValidPrinterFilter();
    });
  }
  await loadDevices();
}

function getScanTarget() {
  const ip = (document.getElementById("scan-ip")?.value || "").trim();
  const user = (document.getElementById("scan-user")?.value || "").trim();
  const password = (document.getElementById("scan-password")?.value || "").trim();
  return { ip, user, password };
}

async function ensureScanTargetDefaults() {
  const ipInput = document.getElementById("scan-ip");
  const userInput = document.getElementById("scan-user");
  if (!ipInput) return;
  if (String(ipInput.value || "").trim()) return;
  try {
    const cfg = await jsonFetch("/api/dashboard/config");
    const testIp = String(cfg?.env?.TEST_IP || "").trim();
    const testUser = String(cfg?.env?.TEST_USER || "").trim();
    if (testIp) ipInput.value = testIp;
    if (userInput && !String(userInput.value || "").trim() && testUser) {
      userInput.value = testUser;
    }
  } catch (_err) {
    // Keep manual input flow if config is unavailable.
  }
}

function renderScanAddressRows(entries) {
  const body = document.getElementById("scan-address-table-body");
  if (!body) return;
  const rows = Array.isArray(entries) ? entries.filter((x) => x && x.type !== "Summary") : [];
  if (!rows.length) {
    body.innerHTML = `<tr><td colspan="7">No address entries.</td></tr>`;
    return;
  }
  body.innerHTML = rows
    .map((row) => {
      const type = row.type || "-";
      const reg = row.registration_no || "";
      const name = row.name || "-";
      const userCode = row.user_code || "-";
      const email = row.email_address || "-";
      const folder = row.folder || "-";
      return `
        <tr>
          <td>${type}</td>
          <td>${reg}</td>
          <td>${name}</td>
          <td>${userCode}</td>
          <td>${email}</td>
          <td>${folder}</td>
          <td><button class="btn action alt scan-delete-btn" data-registration-no="${String(reg).replaceAll('"', "&quot;")}">Delete</button></td>
        </tr>
      `;
    })
    .join("");
}

async function loadScanAddressList() {
  const out = document.getElementById("scan-output");
  const target = getScanTarget();
  if (!target.ip) throw new Error("Missing printer IP");
  const query = new URLSearchParams(target).toString();
  const data = await jsonFetch(`/api/scan/address-list?${query}`);
  const payload = data.payload || {};
  const entries = payload.address_list || [];
  renderScanAddressRows(entries);
  if (out) out.textContent = JSON.stringify(payload, null, 2);
}

async function initScanPage() {
  const targetForm = document.getElementById("scan-target-form");
  const createForm = document.getElementById("scan-create-form");
  const modifyForm = document.getElementById("scan-modify-form");
  const out = document.getElementById("scan-output");
  if (!targetForm || !createForm || !modifyForm) return;

  if (!targetForm.dataset.bound) {
    targetForm.dataset.bound = "1";
    targetForm.addEventListener("submit", async (event) => {
      event.preventDefault();
      try {
        await loadScanAddressList();
      } catch (err) {
        if (out) out.textContent = String(err?.message || err);
      }
    });
  }

  if (!createForm.dataset.bound) {
    createForm.dataset.bound = "1";
    createForm.addEventListener("submit", async (event) => {
      event.preventDefault();
      const target = getScanTarget();
      if (!target.ip) {
        if (out) out.textContent = "Missing printer IP";
        return;
      }
      const body = {
        ...target,
        name: (document.getElementById("scan-create-name")?.value || "").trim(),
        email: (document.getElementById("scan-create-email")?.value || "").trim(),
        folder: (document.getElementById("scan-create-folder")?.value || "").trim(),
        user_code: (document.getElementById("scan-create-user-code")?.value || "").trim(),
        fields: { entryTypeIn: "1" },
      };
      try {
        const data = await jsonFetch("/api/scan/address-create", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });
        if (out) out.textContent = JSON.stringify(data.payload || data, null, 2);
        await loadScanAddressList();
      } catch (err) {
        if (out) out.textContent = String(err?.message || err);
      }
    });
  }

  if (!modifyForm.dataset.bound) {
    modifyForm.dataset.bound = "1";
    modifyForm.addEventListener("submit", async (event) => {
      event.preventDefault();
      const target = getScanTarget();
      if (!target.ip) {
        if (out) out.textContent = "Missing printer IP";
        return;
      }
      const body = {
        ...target,
        registration_no: (document.getElementById("scan-modify-registration-no")?.value || "").trim(),
        name: (document.getElementById("scan-modify-name")?.value || "").trim(),
        email: (document.getElementById("scan-modify-email")?.value || "").trim(),
        folder: (document.getElementById("scan-modify-folder")?.value || "").trim(),
        user_code: (document.getElementById("scan-modify-user-code")?.value || "").trim(),
        fields: {},
      };
      if (!body.registration_no) {
        if (out) out.textContent = "Missing registration_no";
        return;
      }
      try {
        const data = await jsonFetch("/api/scan/address-modify", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });
        if (out) out.textContent = JSON.stringify(data.payload || data, null, 2);
        await loadScanAddressList();
      } catch (err) {
        if (out) out.textContent = String(err?.message || err);
      }
    });
  }

  const tableBody = document.getElementById("scan-address-table-body");
  if (tableBody && !tableBody.dataset.bound) {
    tableBody.dataset.bound = "1";
    tableBody.addEventListener("click", async (event) => {
      const btn = event.target.closest(".scan-delete-btn");
      if (!btn) return;
      const registrationNo = String(btn.dataset.registrationNo || "").trim();
      if (!registrationNo) return;
      if (!window.confirm(`Delete registration_no ${registrationNo}?`)) return;
      const target = getScanTarget();
      if (!target.ip) {
        if (out) out.textContent = "Missing printer IP";
        return;
      }
      try {
        const data = await jsonFetch("/api/scan/address-delete", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ ...target, registration_no: registrationNo }),
        });
        if (out) out.textContent = JSON.stringify(data.payload || data, null, 2);
        await loadScanAddressList();
      } catch (err) {
        if (out) out.textContent = String(err?.message || err);
      }
    });
  }

  // Auto-load once on page open so user does not need to click "Load Address List".
  if (!targetForm.dataset.autoLoaded) {
    targetForm.dataset.autoLoaded = "1";
    try {
      await ensureScanTargetDefaults();
      await loadScanAddressList();
    } catch (err) {
      if (out) out.textContent = String(err?.message || err);
    }
  }
}

const dashboardState = {
  env: {},
  env_overrides: {},
  device_filters: {},
  network: {},
  computers: [],
  printers: [],
  links: [],
};

function setDashboardMessage(text) {
  const out = document.getElementById("dashboard-config-output");
  if (out) out.textContent = text;
}

function renderEnvGrid(envPayload) {
  const root = document.getElementById("env-config-grid");
  if (!root) return;
  const keys = Object.keys(envPayload || {});
  if (!keys.length) {
    root.innerHTML = `<div class="hint">No env values available.</div>`;
    return;
  }
  root.innerHTML = keys
    .map(
      (key) => `
      <div class="env-item">
        <div class="env-key">${key}</div>
        <div class="env-value">${envPayload[key] ?? ""}</div>
      </div>`
    )
    .join("");
}

function renderEnvOverrideForm(envOverrides) {
  const form = document.getElementById("env-override-form");
  if (!form) return;
  Object.keys(envOverrides || {}).forEach((key) => {
    if (!form.elements[key]) return;
    form.elements[key].value = envOverrides[key] ?? "";
  });
}

function renderDeviceFilterForm(deviceFilters) {
  const form = document.getElementById("device-filter-form");
  if (!form) return;
  const values = deviceFilters?.ignore_printer_prefixes || [];
  const mode = String(deviceFilters?.filter_mode || "all");
  if (form.elements.ignore_printer_prefixes) {
    form.elements.ignore_printer_prefixes.value = Array.isArray(values) ? values.join(",") : "";
  }
  if (form.elements.filter_mode) {
    form.elements.filter_mode.value = mode === "valid_only" ? "valid_only" : "all";
  }
}

function renderNetworkForm(networkPayload) {
  const form = document.getElementById("network-config-form");
  if (!form) return;
  ["subnet_mask", "gateway", "dns_primary", "dns_secondary", "snmp_community", "snmp_port", "timeout_seconds"].forEach(
    (key) => {
      if (!form.elements[key]) return;
      form.elements[key].value = networkPayload[key] ?? "";
    }
  );
}

function renderComputersTable(computers) {
  const body = document.getElementById("computers-body");
  if (!body) return;
  if (!computers.length) {
    body.innerHTML = `<tr><td colspan="4">No computers configured.</td></tr>`;
    return;
  }
  body.innerHTML = computers
    .map(
      (row) => `
      <tr>
        <td>${row.name}</td>
        <td>${row.ip || "-"}</td>
        <td>${row.department || "-"}</td>
        <td><button class="btn action alt js-delete-computer" data-id="${row.id}">Delete</button></td>
      </tr>`
    )
    .join("");
}

function renderPrintersTable(printers) {
  const body = document.getElementById("printers-body");
  if (!body) return;
  if (!printers.length) {
    body.innerHTML = `<tr><td colspan="5">No printers configured.</td></tr>`;
    return;
  }
  body.innerHTML = printers
    .map(
      (row) => `
      <tr>
        <td>${row.name}</td>
        <td>${row.ip || "-"}</td>
        <td>${row.model || "-"}</td>
        <td>${row.location || "-"}</td>
        <td><button class="btn action alt js-delete-printer" data-id="${row.id}">Delete</button></td>
      </tr>`
    )
    .join("");
}

function buildLinkKey(computerId, printerId) {
  return `${computerId}:${printerId}`;
}

function renderLinkMatrix(computers, printers, links) {
  const table = document.getElementById("link-matrix");
  if (!table) return;
  const thead = table.querySelector("thead");
  const tbody = table.querySelector("tbody");
  if (!thead || !tbody) return;
  if (!computers.length || !printers.length) {
    thead.innerHTML = "";
    tbody.innerHTML = `<tr><td>Need at least 1 computer and 1 printer to map.</td></tr>`;
    return;
  }

  const selected = new Set((links || []).map((row) => buildLinkKey(row.computer_id, row.printer_id)));
  thead.innerHTML = `
    <tr>
      <th>Computer \\ Printer</th>
      ${printers.map((printer) => `<th>${printer.name}</th>`).join("")}
    </tr>`;

  tbody.innerHTML = computers
    .map((computer) => {
      return `
        <tr>
          <td><strong>${computer.name}</strong><br /><span class="hint">${computer.ip || "-"}</span></td>
          ${printers
            .map((printer) => {
              const key = buildLinkKey(computer.id, printer.id);
              const checked = selected.has(key) ? "checked" : "";
              return `
                <td>
                  <label class="mini-switch">
                    <input type="checkbox" data-link-check="1" data-computer-id="${computer.id}" data-printer-id="${printer.id}" ${checked} />
                    <span class="mini-slider"></span>
                  </label>
                </td>`;
            })
            .join("")}
        </tr>`;
    })
    .join("");
}

function collectLinkPayload() {
  const nodes = document.querySelectorAll('input[data-link-check="1"]:checked');
  return Array.from(nodes).map((node) => ({
    computer_id: Number(node.dataset.computerId || 0),
    printer_id: Number(node.dataset.printerId || 0),
  }));
}

function bindDashboardActions() {
  const networkForm = document.getElementById("network-config-form");
  const envForm = document.getElementById("env-override-form");
  const deviceFilterForm = document.getElementById("device-filter-form");
  const computerForm = document.getElementById("computer-form");
  const printerForm = document.getElementById("printer-form");
  const saveLinksBtn = document.getElementById("save-links-btn");
  const computersBody = document.getElementById("computers-body");
  const printersBody = document.getElementById("printers-body");

  if (networkForm && !networkForm.dataset.bound) {
    networkForm.dataset.bound = "1";
    networkForm.addEventListener("submit", async (event) => {
      event.preventDefault();
      const payload = {
        subnet_mask: networkForm.elements.subnet_mask.value,
        gateway: networkForm.elements.gateway.value,
        dns_primary: networkForm.elements.dns_primary.value,
        dns_secondary: networkForm.elements.dns_secondary.value,
        snmp_community: networkForm.elements.snmp_community.value,
        snmp_port: Number(networkForm.elements.snmp_port.value || 161),
        timeout_seconds: Number(networkForm.elements.timeout_seconds.value || 10),
      };
      try {
        await jsonFetch("/api/dashboard/network", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        setDashboardMessage("Saved network config.");
      } catch (err) {
        setDashboardMessage(`Save network config failed: ${err.message}`);
      }
    });
  }

  if (envForm && !envForm.dataset.bound) {
    envForm.dataset.bound = "1";
    envForm.addEventListener("submit", async (event) => {
      event.preventDefault();
      const payload = {
        API_URL: envForm.elements.API_URL.value,
        USER_TOKEN: envForm.elements.USER_TOKEN.value,
        DATABASE_URL: envForm.elements.DATABASE_URL.value,
        WS_URL: envForm.elements.WS_URL.value,
        WS_AUTO_CONNECT: envForm.elements.WS_AUTO_CONNECT.value,
        WEBHOOK_MODE: envForm.elements.WEBHOOK_MODE.value,
        WEBHOOK_LISTEN_PATH: envForm.elements.WEBHOOK_LISTEN_PATH.value,
        TEST_IP: envForm.elements.TEST_IP.value,
        TEST_USER: envForm.elements.TEST_USER.value,
        TEST_PASSWORD: envForm.elements.TEST_PASSWORD.value,
        POLLING_ENABLED: envForm.elements.POLLING_ENABLED.value,
        POLLING_URL: envForm.elements.POLLING_URL.value,
        POLLING_LEAD: envForm.elements.POLLING_LEAD.value,
        POLLING_TOKEN: envForm.elements.POLLING_TOKEN.value,
        POLLING_INTERVAL_SECONDS: envForm.elements.POLLING_INTERVAL_SECONDS.value,
        POLLING_LAN_UID: envForm.elements.POLLING_LAN_UID.value,
        POLLING_AGENT_UID: envForm.elements.POLLING_AGENT_UID.value,
      };
      try {
        await jsonFetch("/api/dashboard/env", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        await loadDashboardConfig();
        setDashboardMessage("Saved ENV overrides to DB.");
      } catch (err) {
        setDashboardMessage(`Save ENV overrides failed: ${err.message}`);
      }
    });
  }

  if (deviceFilterForm && !deviceFilterForm.dataset.bound) {
    deviceFilterForm.dataset.bound = "1";
    deviceFilterForm.addEventListener("submit", async (event) => {
      event.preventDefault();
      const payload = {
        ignore_printer_prefixes: deviceFilterForm.elements.ignore_printer_prefixes.value,
        filter_mode: deviceFilterForm.elements.filter_mode?.value || "all",
      };
      try {
        await jsonFetch("/api/dashboard/device-filters", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        await loadDashboardConfig();
        setDashboardMessage("Saved device filters.");
      } catch (err) {
        setDashboardMessage(`Save device filters failed: ${err.message}`);
      }
    });
  }

  if (computerForm && !computerForm.dataset.bound) {
    computerForm.dataset.bound = "1";
    computerForm.addEventListener("submit", async (event) => {
      event.preventDefault();
      const payload = {
        name: computerForm.elements.name.value,
        ip: computerForm.elements.ip.value,
        department: computerForm.elements.department.value,
      };
      try {
        await jsonFetch("/api/dashboard/computers", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        computerForm.reset();
        await loadDashboardConfig();
        setDashboardMessage("Added computer.");
      } catch (err) {
        setDashboardMessage(`Add computer failed: ${err.message}`);
      }
    });
  }

  if (printerForm && !printerForm.dataset.bound) {
    printerForm.dataset.bound = "1";
    printerForm.addEventListener("submit", async (event) => {
      event.preventDefault();
      const payload = {
        name: printerForm.elements.name.value,
        ip: printerForm.elements.ip.value,
        model: printerForm.elements.model.value,
        location: printerForm.elements.location.value,
      };
      try {
        await jsonFetch("/api/dashboard/printers", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        printerForm.reset();
        await loadDashboardConfig();
        setDashboardMessage("Added printer.");
      } catch (err) {
        setDashboardMessage(`Add printer failed: ${err.message}`);
      }
    });
  }

  if (saveLinksBtn && !saveLinksBtn.dataset.bound) {
    saveLinksBtn.dataset.bound = "1";
    saveLinksBtn.addEventListener("click", async () => {
      const payload = { links: collectLinkPayload() };
      try {
        const resp = await jsonFetch("/api/dashboard/links", {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        setDashboardMessage(`Saved mapping: ${resp.total_links} links.`);
      } catch (err) {
        setDashboardMessage(`Save mapping failed: ${err.message}`);
      }
    });
  }

  if (computersBody && !computersBody.dataset.bound) {
    computersBody.dataset.bound = "1";
    computersBody.addEventListener("click", async (event) => {
      const btn = event.target.closest(".js-delete-computer");
      if (!btn) return;
      try {
        await jsonFetch(`/api/dashboard/computers/${btn.dataset.id}`, { method: "DELETE" });
        await loadDashboardConfig();
        setDashboardMessage("Deleted computer.");
      } catch (err) {
        setDashboardMessage(`Delete computer failed: ${err.message}`);
      }
    });
  }

  if (printersBody && !printersBody.dataset.bound) {
    printersBody.dataset.bound = "1";
    printersBody.addEventListener("click", async (event) => {
      const btn = event.target.closest(".js-delete-printer");
      if (!btn) return;
      try {
        await jsonFetch(`/api/dashboard/printers/${btn.dataset.id}`, { method: "DELETE" });
        await loadDashboardConfig();
        setDashboardMessage("Deleted printer.");
      } catch (err) {
        setDashboardMessage(`Delete printer failed: ${err.message}`);
      }
    });
  }
}

async function loadDashboardConfig() {
  try {
    const data = await jsonFetch("/api/dashboard/config");
    dashboardState.env = data.env || {};
    dashboardState.env_overrides = data.env_overrides || {};
    dashboardState.device_filters = data.device_filters || {};
    dashboardState.network = data.network || {};
    dashboardState.computers = data.computers || [];
    dashboardState.printers = data.printers || [];
    dashboardState.links = data.links || [];

    renderEnvGrid(dashboardState.env);
    renderEnvOverrideForm(dashboardState.env_overrides);
    renderDeviceFilterForm(dashboardState.device_filters);
    renderNetworkForm(dashboardState.network);
    renderComputersTable(dashboardState.computers);
    renderPrintersTable(dashboardState.printers);
    renderLinkMatrix(dashboardState.computers, dashboardState.printers, dashboardState.links);
  } catch (err) {
    setDashboardMessage(`Load dashboard config failed: ${err.message}`);
  }
}

function bindMobileMenu() {
  const shell = document.getElementById("layout-shell");
  const openBtn = document.getElementById("nav-toggle");
  const closeBtn = document.getElementById("nav-close");
  const overlay = document.getElementById("sidebar-overlay");
  if (!shell || !openBtn || !closeBtn || !overlay) return;
  if (openBtn.dataset.bound) return;
  const closeMenu = () => shell.classList.remove("nav-open");
  const openMenu = () => shell.classList.add("nav-open");
  openBtn.dataset.bound = "1";
  openBtn.addEventListener("click", openMenu);
  closeBtn.addEventListener("click", closeMenu);
  overlay.addEventListener("click", closeMenu);
  shell.querySelectorAll(".side-link").forEach((link) => {
    link.addEventListener("click", closeMenu);
  });
}

document.addEventListener("DOMContentLoaded", () => {
  bindMobileMenu();
  const page = document.body.dataset.page;
  if (page === "dashboard") {
    bindDashboardActions();
    loadDashboardConfig();
  }
  if (page === "analytics") loadOverview().catch(() => {});
  if (page === "devices") {
    loadOverview().catch(() => {});
    initDevicesPage().catch(() => {});
  }
  if (page === "scan") {
    initScanPage().catch(() => {});
  }
  const refresh = document.getElementById("refresh-btn");
  if (refresh) {
    refresh.addEventListener("click", async () => {
      if (page === "dashboard") {
        loadDashboardConfig();
      } else if (page === "devices") {
        loadOverview().catch(() => {});
        loadDevices(true).catch(() => {});
      } else if (page === "scan") {
        loadScanAddressList().catch(() => {});
      } else {
        loadOverview().catch(() => {});
      }
    });
  }
});

</script>

